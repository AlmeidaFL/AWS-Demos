# AWS API Gateway REST vs HTTP API Demo

This project demonstrates the differences between AWS API Gateway REST API and HTTP API by deploying both types with the same Lambda function backend. It showcases features like API keys, usage plans, throttling, Lambda authorization, and different event structures.

This comparison is useful for understanding when to choose REST API vs HTTP API based on your specific requirements and feature needs.

---

## Requirements

- AWS CLI installed and configured (aws configure)
- SAM CLI installed
- Sufficient permissions to create resources
- SSM Parameter Store parameter named `jwt-secret` with a JWT secret value

---

## Project Structure

```
api-gateway-rest-vs-http-demo/
├── lambda/                 # Lambda function source code
│   └── app.js
├── auth/                   # Lambda authorizer source code
│   ├── authorizer.js
│   ├── package.json
│   └── generate-token.js
├── template.yaml           # CloudFormation template (with Transform: SAM)
├── samconfig.toml          # SAM configuration file
├── packaged.yaml           # Generated by `cloudformation package` (ignored)
├── .aws-sam/              # SAM build artifacts (ignored)
├── .gitignore              # Excludes artifacts and local files
└── README.md               # Project instructions and documentation
```

---

## Step-by-Step Guide

### 1. Create JWT Secret in SSM Parameter Store

```bash
# Create the JWT secret parameter (required for Lambda authorizer)
aws ssm put-parameter --name "jwt-secret" --value "super-secret-key" --type "SecureString" --region your-region
```

### 2. Deploy the Stack

```bash
# Build and deploy using SAM CLI
sam build
sam deploy --guided

# Or deploy using existing samconfig.toml
sam deploy
```

### 3. Testing the APIs

#### Get API URLs and API Key

```bash
# Get stack outputs
sam list stack-outputs --stack-name api-gateway-http

# Get API Key value (needed for REST API with usage plan)
aws apigateway get-api-key --api-key YOUR_API_KEY_ID --include-value --query 'value' --output text
```

#### Generate JWT Token for HTTP API Authorization

```bash
# Navigate to auth directory and generate a JWT token
cd auth
node generate-token.js
# Copy the generated token for use in HTTP API requests
```

#### Test REST API

```bash
# Test REST API Hello endpoint (requires API key)
curl -H "X-API-Key: YOUR_API_KEY_VALUE" "https://YOUR_REST_API_ID.execute-api.YOUR_REGION.amazonaws.com/prod/hello/John?filter=recent&size=10"

# Test REST API Search endpoint (requires API key)
curl -H "X-API-Key: YOUR_API_KEY_VALUE" "https://YOUR_REST_API_ID.execute-api.YOUR_REGION.amazonaws.com/prod/search?filter=products&size=5"
```

#### Test HTTP API

```bash
# Test HTTP API Hello endpoint (requires JWT authorization)
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" "https://YOUR_HTTP_API_ID.execute-api.YOUR_REGION.amazonaws.com/hello/Jane?filter=latest&size=20"

# Test HTTP API Search endpoint (no authorization required)
curl "https://YOUR_HTTP_API_ID.execute-api.YOUR_REGION.amazonaws.com/search?filter=services&size=15"
```

### 4. Compare Event Structures

The Lambda function returns the complete event object, allowing you to see the differences between REST API and HTTP API event structures:

- **REST API**: More detailed event structure with extensive request context
- **HTTP API**: Simplified event structure optimized for performance

### 5. Test Usage Plan Limits (REST API only)

```bash
# Make multiple requests to test throttling (REST API has 10 requests/second rate limit)
for i in {1..15}; do
  curl -H "X-API-Key: YOUR_API_KEY_VALUE" "https://YOUR_REST_API_ID.execute-api.YOUR_REGION.amazonaws.com/prod/hello/test$i"
  echo "Request $i completed"
done
```

### 6. Clean Up Resources

```bash
# Delete the stack
sam delete

# (Optional) Delete SSM parameter
aws ssm delete-parameter --name "jwt-secret" --region your-region
```

---

## Authorization Requirements

### REST API Authorization
- **API Key Required**: All REST API endpoints require a valid API key in the `X-API-Key` header
- **Usage Plan**: API key is associated with a usage plan that enforces throttling (10 requests/second, burst limit of 2) and quota (5 requests/month)

### HTTP API Authorization
- **Hello Endpoint**: Requires JWT token authorization via Lambda authorizer
  - Token must be provided in `Authorization` header as `Bearer TOKEN`
  - Token must be signed with the secret stored in SSM Parameter Store (`jwt-secret`)
  - User must have valid role permissions (user: admin)
- **Search Endpoint**: No authorization required

---

## Key Differences: REST API vs HTTP API

One of the differences is that HTTP API is cheaper than REST API type: ["Most customers will see an average cost saving up to 70%, when compared to API Gateway REST APIs"](https://aws.amazon.com/pt/blogs/compute/announcing-http-apis-for-amazon-api-gateway/)

See other differences here: https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html

---

## Important Notes

- **JWT Secret**: The Lambda authorizer requires a JWT secret stored in SSM Parameter Store. Ensure the parameter `jwt-secret` exists before deployment
- **API Key Values**: For security reasons, API key values cannot be exposed through CloudFormation outputs. You must retrieve them using the AWS CLI
- **Rate Limiting**: REST API includes built-in throttling via usage plans, while HTTP API requires custom implementation
- **Access Logs**: HTTP API includes CloudWatch access logging configured in the template
- **Lambda Authorizer**: HTTP API uses a custom Lambda authorizer for JWT validation with caching for improved performance

---