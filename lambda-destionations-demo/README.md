# AWS Lambda with Destinations – Success/Failure Routing Demo

This project demonstrates how to deploy an AWS Lambda function with configured destinations that route execution results to different Amazon SQS queues based on success or failure outcomes.

This pattern is useful for asynchronous workflows, decoupled architectures, and implementing robust error handling.

---

## Requirements

- AWS CLI installed and configured (aws configure)
- Sufficient permissions to create resources

---

## Project Structure

```
lambda-destinations-demo/
├── lambda/                 # Lambda function source code
│   └── index.js
├── event.json              # Test event to invoke the lambda
├── template.yaml           # CloudFormation template (with Transform: SAM)
├── packaged.yaml           # Generated by `cloudformation package` (ignored)
├── response.json           # Output from Lambda invoke (ignored)
├── .gitignore              # Excludes artifacts and local files
└── README.md               # Project instructions and documentation
```

---

## Step-by-Step Guide

### 1. Create an S3 Bucket (only once)

```bash
# S3 bucket is required
aws s3 mb s3://unique-bucket-name --region your-region

# Ensure the `template.yaml` file is created before running this command.

# Package SAM template
aws cloudformation package --template-file template.yaml --s3-bucket unique-bucket-name --output-template-file packaged.yaml

# Deploy stack
aws cloudformation deploy --template-file packaged.yaml --stack-name lambda-destinations-demo --capabilities CAPABILITY_NAMED_IAM --region your-region

# Testing success scenario (modify event.json to set shouldFail: false)
aws lambda invoke --function-name DestinationLambda --payload event.json --invocation-type Event response.json

# Testing failure scenario (modify event.json to set shouldFail: true)
aws lambda invoke --function-name DestinationLambda --payload event.json --invocation-type Event response.json

# Reading from success queue
aws sqs receive-message --queue-url success-queue-url --max-number-of-messages 1

# Reading from failure queue
aws sqs receive-message --queue-url failure-queue-url --max-number-of-messages 1

# Cleaning up stack
aws cloudformation delete-stack --stack-name lambda-destinations-demo

# (Optional) delete S3 bucket
```

## Important note related to failure scenario

As stated by [AWS](https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-resource-lambda-eventinvokeconfig.html), "By default, Lambda retries an asynchronous invocation twice if the function returns an error. It retains events in a queue for up to six hours"

This can be alter by using the **MaximumEventAgeInSeconds** API