# AWS Lambda with Partial Batch Failure – SQS Event Source Demo

This demo demonstrates how to configure AWS Lambda to handle partial batch failures when processing messages from an Amazon SQS queue. When multiple messages are received in a batch, the Lambda function can selectively mark specific messages as failed without failing the entire batch.

This pattern is useful for robust message processing where you want to only retry specific failed messages instead of the entire batch.

---

## Requirements

- AWS CLI installed and configured (aws configure)
- Sufficient permissions to create resources

---

## Project Structure

```
lambda-partial-batch-failure-demo/
├── lambda/                 # Lambda function source code
│   └── index.js
├── template.yaml           # CloudFormation template (with Transform: SAM)
├── packaged.yaml           # Generated by `cloudformation package` (ignored)
├── .gitignore              # Excludes artifacts and local files
└── README.md               # Project instructions and documentation
```

---

## Step-by-Step Guide

### 1. Create an S3 Bucket (only once)

```bash
# S3 bucket is required (use your own unique bucket name)
aws s3 mb s3://unique-bucket-name --region your-region
```

### 2. Deploy the Stack

```bash
# Package SAM template
aws cloudformation package --template-file template.yaml --s3-bucket unique-bucket-name --output-template-file packaged.yaml

# Deploy stack
aws cloudformation deploy --template-file packaged.yaml --stack-name lambda-partial-batch-failure-demo --capabilities CAPABILITY_NAMED_IAM --region your-region
```

### 3. Testing the Lambda Function

```bash
# Get the queue URL
aws sqs get-queue-url --queue-name SourceQueue

# Send test messages to the queue
# Message that will succeed
aws sqs send-message --queue-url queue-url-from-above --message-body "This will succeed"

# Message that will fail
aws sqs send-message --queue-url queue-url-from-above --message-body "fail"

# Check DLQ for failed messages
aws sqs get-queue-url --queue-name SourceDlqQueue
aws sqs receive-message --queue-url dlq-url-from-above --max-number-of-messages 10
```

### 4. Clean Up Resources

```bash
# Delete the stack
aws cloudformation delete-stack --stack-name lambda-partial-batch-failure-demo
```

## How It Works

1. The Lambda function is triggered with a batch of SQS messages (batch size = 5)
2. The function processes each message individually
3. Messages with the content "fail" are reported as failures using the `batchItemFailures` response
4. Failed messages are kept in the source queue for reprocessing
5. After multiple failures (defined by `maxReceiveCount`), failed messages go to the DLQ
6. Successfully processed messages are automatically deleted from the source queue

## Important Notes

- The `FunctionResponseTypes: ReportBatchItemFailures` configuration is essential for enabling partial batch failure handling